{"version":3,"sources":["../../../../src/Modules/Marketplace/Components/InstallModal.jsx"],"names":["InstallModal","props","state","messages","started","ended","progress","finished","bindMethods","Progress","setState","api","Api","Endpoint","currentResponseLength","push","message","id","setConfig","downloadProgress","response","e","currentTarget","length","newLength","substring","split","filter","l","map","res","JSON","parse","line","roles","Model","set","parseInt","unshift","lastId","get","app","then","apiResponse","isError","getError","appName","localName","includeApp","run","Router","start","setTimeout","i18n","name","hide","Growl","success","resetState","Modal","Button","Link","Grid","Logic","Alert","onClose","startInstallation","height","overflow","fontSize","logger","ref","m","Ui","ModalComponent","createComponent","styles","modules"],"mappings":"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","file":"InstallModal.js","sourcesContent":["import React from 'react';\nimport {Webiny} from 'webiny-client';\nimport styles from './../Views/styles.css';\n\n/**\n * @i18n.namespace Webiny.Backend.Marketplace.InstallModal\n */\nclass InstallModal extends Webiny.Ui.ModalComponent {\n    constructor(props) {\n        super(props);\n\n        // started - installation has started\n        // ended - API call has ended\n        // finished - installation reached 100%\n\n        this.state = {messages: [], started: false, ended: false, progress: 0, finished: false};\n\n        this.bindMethods('startInstallation,onClose');\n    }\n\n    startInstallation() {\n        const {Progress} = this.props;\n        this.setState({started: true});\n        const api = new Webiny.Api.Endpoint('/services/webiny/marketplace');\n        let currentResponseLength = false;\n\n        // Add initial message\n        const messages = this.state.messages;\n        messages.push({message: 'Fetching app details...', id: 0});\n        this.setState({messages});\n\n        api.setConfig({\n            downloadProgress: e => {\n                let response = e.currentTarget.response || '';\n                if (currentResponseLength === false) {\n                    currentResponseLength = response.length;\n                }\n                else {\n                    const newLength = response.length;\n                    response = response.substring(currentResponseLength);\n                    currentResponseLength = newLength;\n                }\n\n                // We may receive multiple messages in a single line so we need to handle them using a delimiter\n                response.split(\"_-_\").filter(l => l.length).map(line => {\n                    try {\n                        const res = JSON.parse(line);\n                        if (res.roles) {\n                            Webiny.Model.set(['User', 'roles'], res.roles);\n                        }\n\n                        if (res.progress) {\n                            this.setState(function(state){\n                                const messages = state.messages;\n                                messages[0].message = <Progress value={parseInt(res.progress)}/>;\n                                return {messages, progress: parseInt(res.progress), finished: res.progress === 100};\n                            });\n                        }\n\n                        if (res.message) {\n                            this.setState(function (state) {\n                                const messages = state.messages;\n                                messages.unshift(res);\n                                return {messages, lastId: res.id};\n                            });\n                        }\n                    } catch (e) {\n\n                    }\n                });\n            }\n        });\n\n        return api.get(`apps/${this.props.app.id}/install`).then(apiResponse => {\n            this.setState({ended: true});\n\n            if (apiResponse.isError()) {\n                const messages = this.state.messages;\n                messages.push(apiResponse.getError());\n                this.setState({messages});\n                return;\n            }\n\n            if (this.state.finished) {\n                const appName = this.props.app.localName + '.Backend';\n                Webiny.includeApp(appName).then(app => app.run()).then(() => {\n                    Webiny.Model.set(['Navigation', 'highlight'], appName);\n                    Webiny.Router.start();\n                    setTimeout(() => {\n                        const message = (\n                            <span>{this.i18n('{app} was installed successfully!', {app: <strong>{this.props.app.name}</strong>})}</span>\n                        );\n                        this.hide().then(() => Webiny.Growl.success(message, this.i18n('Installation finished!'), false, 4000));\n                    }, 2000);\n                });\n            }\n        });\n    }\n\n    resetState() {\n        this.setState({messages: [], started: false, ended: false, progress: 0, finished: false});\n    }\n\n    show() {\n        this.resetState();\n        return super.show();\n    }\n\n    onClose() {\n        if (!this.state.started || this.state.ended) {\n            this.hide();\n        }\n    }\n\n    renderDialog() {\n        const {Modal, Button, Link, Grid, Logic, Alert} = this.props;\n\n        return (\n            <Modal.Dialog closeOnClick={!this.state.started || this.state.ended} onClose={this.onClose}>\n                <Modal.Content>\n                    <Modal.Header onClose={this.onClose} title={this.i18n('Install')}/>\n                    <Modal.Body>\n                        <Logic.Hide if={this.state.started}>\n                            <Alert type=\"warning\" title={this.i18n('Notice')}>\n                                {this.i18n('Make sure your watch process is running before installing the app.')}\n                            </Alert>\n                            <div className=\"text-center\">\n                                <Button type=\"primary\" label={this.i18n('Begin Installation')} onClick={this.startInstallation}/>\n                            </div>\n                        </Logic.Hide>\n                        <Logic.Hide if={!this.state.started}>\n                            <Logic.Show if={this.state.finished}>\n                                <Alert type=\"success\" title={this.i18n('Done')}>\n                                    {this.i18n('Your app is installed and ready to use!')}\n                                </Alert>\n                            </Logic.Show>\n                            <pre style={{height: 500, overflow: 'scroll', fontSize: 12}} ref={ref => this.logger = ref}>\n                            {this.state.messages.map(m => (\n                                <div key={m.id}>{m.message}</div>\n                            ))}\n                            </pre>\n                        </Logic.Hide>\n                    </Modal.Body>\n                    {(this.state.finished || this.state.ended) && (\n                        <Modal.Footer>\n                            <Button align=\"right\" label={this.i18n('Close')} onClick={this.hide}/>\n                        </Modal.Footer>\n                    )}\n                </Modal.Content>\n            </Modal.Dialog>\n        );\n    }\n}\n\nexport default Webiny.createComponent(InstallModal, {styles, modules: ['Modal', 'Button', 'Link', 'Grid', 'Logic', 'Alert', 'Progress']});"]}