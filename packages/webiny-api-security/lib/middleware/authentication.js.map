{"version":3,"sources":["../../src/middleware/authentication.js"],"names":["options","params","next","finish","req","token","get","identity","services","verifyToken","e","data","toString","code"],"mappings":";;;;;;;;;;AACA;;;;AAGA;;;;;kBAKgBA,OAAD,IAA2C;AACtD;;;;;;;;;;;;AAYA;AAAA,mDAAO,WAAOC,MAAP,EAAuBC,IAAvB,EAAuCC,MAAvC,EAA4D;AAC/D,kBAAM,EAAEC,GAAF,KAAUH,MAAhB;AACA,kBAAMI,QACF,OAAOL,QAAQK,KAAf,KAAyB,UAAzB,GAAsCL,QAAQK,KAAR,CAAcD,GAAd,CAAtC,GAA2DA,IAAIE,GAAJ,CAAQN,QAAQK,KAAhB,CAD/D;AAEA,gBAAI,CAACA,KAAL,EAAY;AACR,uBAAOH,MAAP;AACH;;AAED,gBAAI;AACAE,oBAAIG,QAAJ,GAAe,MAAM,eAAIC,QAAJ,CAAaF,GAAb,CAAiB,gBAAjB,EAAmCG,WAAnC,CAA+CJ,KAA/C,CAArB;AACH,aAFD,CAEE,OAAOK,CAAP,EAAU;AACR,uBAAOP,OAAO,gCAAqBO,EAAEC,IAAvB,EAA6BD,EAAEE,QAAF,EAA7B,EAA2CF,EAAEG,IAA7C,EAAmD,GAAnD,CAAP,CAAP;AACH;AACDX;AACH,SAdD;;AAAA;AAAA;AAAA;AAAA;AAeH,C","file":"authentication.js","sourcesContent":["// @flow\nimport { app } from \"webiny-api\";\nimport { ApiErrorResponse } from \"webiny-api\";\n\n/**\n * Authentication middleware factory.\n * @param options\n * @returns {Function} Request middleware function.\n */\nexport default (options: { token: Function | string }) => {\n    /**\n     * Authentication middleware.\n     * Attempts to authenticate the client using the token from request (if any).\n     * If successful, `identity` instance is set on the `req` object itself.\n     * If not successful, we just call the next middleware.\n     *\n     * @param req\n     * @param res\n     * @param services\n     * @param next\n     * @return {Promise<void>}\n     */\n    return async (params: Object, next: Function, finish: Function) => {\n        const { req } = params;\n        const token =\n            typeof options.token === \"function\" ? options.token(req) : req.get(options.token);\n        if (!token) {\n            return next();\n        }\n\n        try {\n            req.identity = await app.services.get(\"authentication\").verifyToken(token);\n        } catch (e) {\n            return finish(new ApiErrorResponse(e.data, e.toString(), e.code, 401));\n        }\n        next();\n    };\n};\n"]}