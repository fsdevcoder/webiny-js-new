{"version":3,"sources":["../../src/endpoint/apiMethod.js"],"names":["ApiMethod","constructor","name","httpMethod","pattern","context","startsWith","callbacks","namedParam","wildcardParam","paramNames","public","params","match","forEach","item","push","replace","wildcardParams","regex","RegExp","setPublic","isPublic","getName","getEndpoint","getPattern","getRegex","exec","req","res","callback","bind","callbackCount","length","parent","noop","createParent","addCallback","callable","unshift","index","bindTo","$this","toJSON","method"],"mappings":"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","file":"apiMethod.js","sourcesContent":["// @flow\nimport _ from \"lodash\";\nimport type { Endpoint } from \"./../endpoint\";\n\nclass ApiMethod {\n    name: string;\n    httpMethod: string;\n    context: Endpoint;\n    pattern: string;\n    callbacks: Array<Function>;\n    regex: RegExp;\n    namedParam: RegExp;\n    wildcardParam: RegExp;\n    paramNames: Array<string>;\n    public: boolean;\n\n    constructor(name: string, httpMethod: string, pattern: string, context: Endpoint) {\n        this.name = name;\n        this.httpMethod = httpMethod;\n        this.context = context;\n        this.pattern = pattern.startsWith(\"/\") ? pattern : \"/\" + pattern;\n        this.callbacks = [];\n        this.namedParam = /:\\w+/g;\n        this.wildcardParam = /\\*\\w+/g;\n        this.paramNames = [];\n        this.public = false;\n\n        // Extract params names\n        const params = pattern.match(this.namedParam);\n        if (params) {\n            params.forEach(item => {\n                this.paramNames.push(item.replace(\":\", \"\"));\n            });\n        }\n\n        const wildcardParams = pattern.match(this.wildcardParam);\n        if (wildcardParams) {\n            wildcardParams.forEach(item => {\n                this.paramNames.push(item.replace(\"*\", \"\"));\n            });\n        }\n\n        // Build route regex\n        const regex = pattern\n            .replace(this.namedParam, \"([^/]+)\")\n            .replace(this.wildcardParam, \"(.*?)\");\n        this.regex = new RegExp(\"^\" + regex + \"$\");\n    }\n\n    setPublic(): this {\n        this.public = true;\n        return this;\n    }\n\n    isPublic(): boolean {\n        return this.public;\n    }\n\n    getName(): string {\n        return this.name;\n    }\n\n    getEndpoint(): Endpoint {\n        return this.context;\n    }\n\n    getPattern(): string {\n        return this.pattern;\n    }\n\n    getRegex(): RegExp {\n        return this.regex;\n    }\n\n    exec(req: express$Request, res: express$Response, params: Object, context: Endpoint) {\n        if (this.httpMethod === \"post\" || this.httpMethod === \"patch\") {\n            // TODO: this.validateBody(req.body);\n        }\n\n        const callback = this.callbacks[0].bind(context);\n        const callbackCount = this.callbacks.length;\n\n        params.req = req;\n        params.res = res;\n\n        let parent = _.noop;\n        if (callbackCount > 1) {\n            parent = this.createParent(1, context);\n        }\n\n        return callback(params, parent);\n    }\n\n    addCallback(callable: Function) {\n        this.callbacks.unshift(callable);\n    }\n\n    createParent(index: number, bindTo: Endpoint) {\n        const $this = this;\n        return function(...params: Array<any>) {\n            let callback = $this.callbacks[index];\n            if ($this.callbacks.length > index + 1) {\n                params.push($this.createParent(index + 1, bindTo));\n            }\n\n            callback = callback.bind(bindTo);\n\n            return callback(...params);\n        };\n    }\n\n    toJSON() {\n        return {\n            name: this.name,\n            method: this.httpMethod,\n            pattern: this.pattern\n        };\n    }\n}\n\nexport default ApiMethod;\n"]}