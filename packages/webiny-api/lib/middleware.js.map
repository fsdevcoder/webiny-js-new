{"version":3,"sources":["../src/middleware.js"],"names":["initApp","config","namespace","setConfig","init","log","createNamespace","Date","now","toString","req","res","next","run","set","response","handleRequest","finished","isEmpty","send"],"mappings":";;;;;;;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;;AAGA,SAASA,OAAT,CAAiBC,MAAjB,EAAiCC,SAAjC,EAA2D;AACvD,eAAIC,SAAJ,CAAcF,MAAd;AACA,eAAIG,IAAJ,CAASF,SAAT;AACH;;AAED;;kBACgBD,MAAD,IAAoB;AAC/B,UAAMI,MAAM,qBAAM,gBAAN,CAAZ;AACA,UAAMH,YAA2B,oBAAII,eAAJ,CAAoBC,KAAKC,GAAL,GAAWC,QAAX,EAApB,CAAjC;AACAT,YAAQC,MAAR,EAAgBC,SAAhB;;AAEA;AACA;AAAA,mDAAO,WAAOQ,GAAP,EAA6BC,GAA7B,EAAoDC,IAApD,EAAuE;AAC1EP,gBAAI,0BAAJ;AACAH,sBAAUW,GAAV,iCAAc,aAAY;AACtB,uBAAO,gCAAC,aAAY;AAChBX,8BAAUY,GAAV,CAAc,KAAd,EAAqBJ,GAArB;AACA,0BAAMK,WAAW,MAAM,WAAIC,aAAJ,CAAkBN,GAAlB,EAAuBC,GAAvB,CAAvB;;AAEA,wBAAIA,IAAIM,QAAR,EAAkB;AACdZ,4BAAI,4DAAJ;AACA;AACH;;AAED,wBAAI,CAAC,iBAAEa,OAAF,CAAUH,QAAV,CAAL,EAA0B;AACtBV,4BAAI,6BAAJ;;AAEA,4BAAIU,sCAAJ,EAAqC;AACjCA,qCAASI,IAAT,CAAcR,GAAd;AACH;AACJ;;AAEDC;AACH,iBAlBM,GAAP;AAmBH,aApBD;AAqBH,SAvBD;;AAAA;AAAA;AAAA;AAAA;AAwBH,C","file":"middleware.js","sourcesContent":["// @flow\nimport _ from \"lodash\";\nimport debug from \"debug\";\nimport { app } from \"./index\";\nimport cls from \"cls-hooked\";\nimport { ApiResponse } from \"./index\";\n\nfunction initApp(config: Object, namespace: cls$Namespace) {\n    app.setConfig(config);\n    app.init(namespace);\n}\n\n// TODO: create Flow object for config\nexport default (config: Object) => {\n    const log = debug(\"api:middleware\");\n    const namespace: cls$Namespace = cls.createNamespace(Date.now().toString());\n    initApp(config, namespace);\n\n    // Route request\n    return async (req: express$Request, res: express$Response, next: Function) => {\n        log(\"Received new API request\");\n        namespace.run(async () => {\n            return (async () => {\n                namespace.set(\"req\", req);\n                const response = await app.handleRequest(req, res);\n\n                if (res.finished) {\n                    log(\"Request was finished before reaching the end of the cycle!\");\n                    return;\n                }\n\n                if (!_.isEmpty(response)) {\n                    log(\"Finished processing request\");\n\n                    if (response instanceof ApiResponse) {\n                        response.send(res);\n                    }\n                }\n\n                next();\n            })();\n        });\n    };\n};\n"]}