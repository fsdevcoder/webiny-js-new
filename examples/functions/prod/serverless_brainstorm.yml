name: webiny-cms-project

components:
  function: '../../../node_modules/@webiny/serverless-function'
  api: '/Users/paveldenisjuk/webiny/js/aws-api-gateway'
  cdn: '/Users/paveldenisjuk/webiny/js/aws-cloudfront'

vars:
  env:
    MONGODB_SERVER: __wby_inject__
    MONGODB_DB_NAME: __wby_inject__
    WEBINY_JWT_SECRET: __wby_inject__
  database:
    server: MONGODB_SERVER
    name: MONGODB_NAME

gateway:
  component: "@webiny/serverless-apollo-gateway"
  inputs:
    services:
      - name: files
        url: ${files.api.url}/graphql
      - name: page-builder
        url: ${pageBuilder.api.url}/graphql

files:
  component: "@webiny/serverless-files"
  inputs:
    database: ${vars.database}
    env: ${vars.env}

pageBuilder:
  component: "@webiny/serverless-page-builder"
  inputs:
    database: ${vars.database}
    env: ${vars.env}
    plugins:
      - @webiny/api-google-tag-manager/plugins
      - @webiny/api-mailchimp/plugins
      - @webiny/api-cookie-policy/plugins

api:
  component: ${components.api}
  inputs:
    name: "GraphQL API"
    description: "GraphQL API"
    stage: prod
    endpointTypes: ['REGIONAL']
    endpoints:
      - path: /graphql
        method: ANY
        function: ${gateway.arn}

cdn:
  component: ${components.cdn}
  inputs:
    origins:
      - url: ${files.api.url}
        pathPatterns: ${files.pathPatterns}
          #"/files/*":
          #  ttl: 60
      - url: ${api.url}
        pathPatterns:
          "/graphql":
            ttl: 0
            forward:
              headers: ["Accept", "Accept-Language"]
            allowedHttpMethods: ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"]
